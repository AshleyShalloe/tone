<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone</title>
    <link rel="stylesheet" href="res/main.css">
    <script src="res/tracks.js"></script>
    <script src="res/main.js"></script>
    <script src="res/conway.js" async></script>
    <script src="res/draggable.js" async></script>
    <link rel="stylesheet" href="res/main.css">
    <style>
        .marker {
            background: black !important;
            color: white !important;
        }
        .marked{
            box-shadow: inset 0px 0px 0px 1px black;
        }
    </style>

</head>

<body>

    <div id="controls" class="card">
        <table>
            <tr>
                <td>Steps</td>
                <td><input id="stepSpinner" type="number" onchange="stepChange(parseInt(this.value))" min="1" /></td>
            </tr>
            <tr>
                <td>Step duration</td>
                <td><input id="stepDurationSpinner" type="number" value="0.5" step="0.01" min="0.01" onchange="stepDurationChange(parseFloat(this.value))" /></td>
            </tr>
        </table>

        <div>
            <div>
                <button class="skeuButton" onclick="initAudioContext(); startAutoplay()">Start</button>
                <button class="skeuButton" onclick="stopAutoplay()">Stop</button>
                <button class="skeuButton" onclick="initAudioContext(); advanceStep()">Step</button>
                <button class="skeuButton" onclick="highlightStep(-1)">&lt;&lt;</button>
                <select id="waveformSelection" onchange="changeWaveform(this.value)">
                    <option disabled="" selected="">Waveform</option>
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            <div>
                <!-- <button class="skeuButton" onclick="loadTrack(tracks.stillAlive)">Load</button> -->
                <button class="skeuButton" onclick="clearNotesIfSure()">Clear</button>
                <div id="trackSelection" style="display: inline-block"></div>
                <button class="skeuButton" onclick="doLoad()">Load</button>
                <button class="skeuButton" onclick="doExport()">Export</button>
            </div>
            <div>
                <button class="skeuButton" onclick="insertColAtCurrentPos()">Insert column</button>
                <button class="skeuButton" onclick="deleteColAtCurrentPos()">Delete column</button>
                <button class="skeuButton" onclick="wideMode()">Wide mode</button>
            </div>
            <span class="card_hide_toggle" onclick="toggleFloatingControls()"></span>
        </div>

        <div id="noteDurationSwitcher" class="single" onclick="cycleNoteDuration()"></div>
    </div>

    <div id="gridContainer" class="card">
        <table id="theGrid"></table>
    </div>

    <div id="postscript" class="card card_hidden">
        <span class='card_hide_toggle' onclick='hideCard(this)'></span>
        <p>This bit is experimental and likely to break everything</p>
        <table>
            <tr>
                <td>Number of octaves</td>
                <td><input id="octaveSpinner" type="number" value="2" step="1" min="2" onchange="octaveChange(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Start octave</td>
                <td><input id="startOctaveSpinner" type="number" value="3" step="1" min="1" onchange="startOctaveChange(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Bar length</td>
                <td><input id="barLengthSpinner" type="number" value="8" step="1" min="2" onchange="doBarShading(parseInt(this.value))"></input></td>
            </tr>
            <tr>
                <td>Game of Life</td>
                <td><button class="skeuButton" onclick="toggleConway(this)">Start</button></td>
            </tr>
            <tr>
                <td>Game of Life interval (ms)</td>
                <td><input type="number" value="500" step="1" min="1" onchange="conwayInterval = parseInt(this.value); restartConway()" /></td>
            </tr>
            <tr>
                <td>Multiply all steps by 2</td>
                <td>
                    <button class="skeuButton" onclick="doubleSpace()">Insert spaces</button>
                    <button class="skeuButton" onclick="doubleSpace(true)">Double notes</button>
                </td>
            </tr>
            <!-- <tr>
                <td>Note duration</td>
                <td>
                    <button class="skeuButton" onclick="removeAllNoteOnclickEvents(); addOnclickToGridCells(); notePickerDuration = 'single'">Whole</button>
                    <button class="skeuButton" onclick="removeAllNoteOnclickEvents(); addHalfNoteOnclickToGridCells(); notePickerDuration = 'half'">Half</button>
                    <button class="skeuButton" onclick="removeAllNoteOnclickEvents(); addDoubleNoteOnclickToGridCells(); notePickerDuration = 'double'">Double</button>
                </td>
            </tr> -->
            <tr>
                <td>Attack</td>
                <td><input type="number" value="1" step="0.01" min="0" max="1" onchange="setAttack(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Release</td>
                <td><input type="number" value="0" step="0.01" min="0" max="1" onchange="setRelease(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Transpose</td>
                <td>
                    <input id="transposeAmountSpinner" type="number" value="1" step="1" min="0" max="12" style="width: 5em" />
                    <button class="skeuButton" onclick="transposeScore(-1 * parseInt(document.getElementById('transposeAmountSpinner').value))" style="width: 3em">-</button>
                    <button class="skeuButton" onclick="transposeScore(parseInt(document.getElementById('transposeAmountSpinner').value))" style="width: 3em">+</button>
                </td>
            </tr>
            <tr>
                <td>(╯°□°)╯︵ ┻━┻</td>
                <td>
                    <button class="skeuButton" onclick="flipScore()">Flip</button>
                </td>
            </tr>
            <tr>
                <td>Mark section</td>
                <td>
                    <button class="skeuButton" onclick="enableMarkerMode()">On</button>
                    <button class="skeuButton" onclick="disableMarkerMode()">Off</button>
                </td>
            </tr>
        </table>
    </div>

</body>
<script>
    'use strict'

    function enableMarkerMode() {
        // add event to headers
        for (var col = 0; col < theGrid.rows[0].cells.length; col++) {
            var cell = theGrid.rows[0].cells[col];
            cell.onclick = function () {
                if (markerArray.length == 2) {
                    markerArray.shift().classList.remove("marker")
                    markerArray.shift().classList.remove("marker")

                    // unhighlight any marked cells
                    var colClass = [...theGrid.getElementsByClassName("marked")];
                    colClass.forEach((element) => {
                        element.classList.remove("marked");
                    });

                    return
                }
                this.classList.add("marker")
                markerArray.push(this)


                if (markerArray.length == 2) {
                    var idx0 = Array.from(markerArray[0].parentNode.children).indexOf(markerArray[0]) - 1
                    var idx1 = Array.from(markerArray[1].parentNode.children).indexOf(markerArray[1]) - 1

                    for (var i = Math.min(idx0, idx1); i <= Math.max(idx0, idx1); i++) {
                        // highlight marked cells
                        var colClass = [...theGrid.getElementsByClassName(`step_${i}`)];
                        colClass.forEach((element) => {
                            element.classList.add("marked");
                        });
                    }
                }
            };
        }
    }

    function disableMarkerMode(){
        loadTrack(getTheScore())
    }

    function init() {
        stepChange(stepCount);
        trackSelectorGenerator();
        read_url_params_and_apply()

        if (doWarn) {
            window.onbeforeunload = function () { return "Your work will be lost."; };
        }
    }

    // globals
    var numberOfOctaves = 2
    var startOctave = 3
    var stepCount = 16
    var currentStep = -1
    var stepDuration = 0.5
    var chromaticScale = ["A", "A♯", "B", "C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯"]
    var audioCtx
    var mainGainNode
    var volume = 0.15
    var autoStepIntervalIdArray = []
    var waveform = "sine"
    var tempState
    var isWideModeEnabled = 0
    var theGrid = document.getElementById("theGrid")
    var doWarn = true
    var attackTime
    var releaseTime
    var notePickerDuration = "single"
    var refreshIntervalId = undefined;
    var conwayInterval = 500
    var controlDiv = document.getElementById("controls")
    var markerArray = []

    // init
    init();
</script>

</html>