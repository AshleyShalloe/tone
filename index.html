<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone</title>
    <link rel="stylesheet" href="res/main.css">
    <script src="res/tracks.js"></script>
    <script src="res/main.js"></script>
    <script src="res/conway.js" async></script>
    <script src="res/draggable.js" async></script>
    <link rel="stylesheet" href="res/main.css">
    <style>
        /* #fancyTrackTable th::first-letter {
            text-transform: capitalize;
        } */

        .tc_faviconContainer img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        #trackCardContainer {
            display: grid;
            grid: auto-flow / 1fr 1fr;
            gap: 10px;
        }

        .trackCard {
            padding: 10px;
            display: grid;
            grid: auto-flow / 32px 1fr;
            gap: 0px 10px;
            font-size: smaller;
            background: rgb(242, 245, 255);
            color: black;
            box-shadow: 2px 2px 4px #80808080, -2px -2px 4px #ffffff6b;
            border-radius: 0.4em;
            border: 1px solid rgb(237, 237, 237);
            cursor: pointer;
        }

        .trackCard:hover {
            background: white;
        }

        .trackCard>div {
            grid-column: 2;
            height: 1em;
        }

        .trackCard>div.tc_faviconContainer {
            grid-column: 1;
        }

        .trackCard .tc_trackTitle {
            font-weight: bold;
            font-size: medium;
        }

        #trackCardContainer>div.tc_categorySection {
            grid-column: 1 / span 2;
            background: black;
            color: white;
            border-radius: 0.4em;
            padding: 10px;
            text-transform: capitalize;
            margin-top: 20px;
        }

        #trackCardContainer>div.tc_categorySection:first-of-type {
            margin-top: 0px;
        }

        .tc_noteCount::before {
            content: "♪×";
        }

        .tc_bpm::after {
            content: "bpm"
        }

        .tc_actualDuration::before {
            content: "Duration: ";
        }

        .tc_category {
            font-style: italic;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>

    <div id="controls" class="card">
        <table>
            <tr>
                <td>Steps</td>
                <td><input id="stepSpinner" type="number" onchange="stepChange(parseInt(this.value))" min="1" /></td>
            </tr>
            <tr>
                <td>Step duration</td>
                <td><input id="stepDurationSpinner" type="number" value="0.5" step="0.01" min="0.01" onchange="stepDurationChange(parseFloat(this.value))" /></td>
            </tr>
        </table>

        <div>
            <div>
                <button class="skeuButton" onclick="initAudioContext(); startAutoplay()">Start</button>
                <button class="skeuButton" onclick="stopAutoplay()">Stop</button>
                <button class="skeuButton" onclick="initAudioContext(); advanceStep()">Step</button>
                <button class="skeuButton" onclick="highlightStep(-1)">&lt;&lt;</button>
                <select id="waveformSelection" onchange="changeWaveform(this.value)">
                    <option disabled="" selected="">Waveform</option>
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            <div>
                <button class="skeuButton" onclick="clearNotesIfSure()">Clear</button>
                <div id="trackSelection" style="display: inline-block"></div>
                <button class="skeuButton" onclick="doLoad()">Load</button>
                <button class="skeuButton" onclick="doExport()">Export</button>
            </div>
            <div>
                <button class="skeuButton" onclick="insertColAtCurrentPos()">Insert column</button>
                <button class="skeuButton" onclick="deleteColAtCurrentPos()">Delete column</button>
                <button class="skeuButton" onclick="wideMode()">Wide mode</button>
            </div>
            <span class="card_hide_toggle" onclick="toggleFloatingControls()"></span>
        </div>

        <div id="noteDurationSwitcher" class="single" onclick="cycleNoteDuration()"></div>
    </div>

    <div id="gridContainer" class="card">
        <table id="theGrid"></table>
    </div>

    <div id="postscript" class="card card_hidden">
        <span class='card_hide_toggle' onclick='hideCard(this)'></span>
        <p>This bit is experimental and likely to break everything</p>
        <table>
            <tr>
                <td>Number of octaves</td>
                <td><input id="octaveSpinner" type="number" value="2" step="1" min="2" onchange="octaveChange(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Start octave</td>
                <td><input id="startOctaveSpinner" type="number" value="3" step="1" min="1" onchange="startOctaveChange(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Bar length</td>
                <td><input id="barLengthSpinner" type="number" value="8" step="1" min="2" onchange="doBarShading(parseInt(this.value))"></input></td>
            </tr>
            <tr>
                <td>Game of Life</td>
                <td><button class="skeuButton" onclick="toggleConway(this)">Start</button></td>
            </tr>
            <tr>
                <td>Game of Life interval (ms)</td>
                <td><input type="number" value="500" step="1" min="1" onchange="conwayInterval = parseInt(this.value); restartConway()" /></td>
            </tr>
            <tr>
                <td>Multiply all steps by 2</td>
                <td>
                    <button class="skeuButton" onclick="doubleSpace()">Insert spaces</button>
                    <button class="skeuButton" onclick="doubleSpace(true)">Double notes</button>
                </td>
            </tr>
            <tr>
                <td>Attack</td>
                <td><input type="number" value="1" step="0.01" min="0" max="1" onchange="setAttack(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Release</td>
                <td><input type="number" value="0" step="0.01" min="0" max="1" onchange="setRelease(parseFloat(this.value))" /></td>
            </tr>
            <tr>
                <td>Transpose</td>
                <td>
                    <input id="transposeAmountSpinner" type="number" value="1" step="1" min="0" max="12" style="width: 5em" />
                    <button class="skeuButton" onclick="transposeScore(-1 * parseInt(document.getElementById('transposeAmountSpinner').value))" style="width: 3em">-</button>
                    <button class="skeuButton" onclick="transposeScore(parseInt(document.getElementById('transposeAmountSpinner').value))" style="width: 3em">+</button>
                </td>
            </tr>
            <tr>
                <td>(╯°□°)╯︵ ┻━┻</td>
                <td>
                    <button class="skeuButton" onclick="flipScore()">Flip</button>
                </td>
            </tr>
            <tr>
                <td>Mark section</td>
                <td>
                    <button class="skeuButton" onclick="enableMarkerMode()" id="markerModeOnBtn">On</button>
                    <button class="skeuButton activeBtn" onclick="disableMarkerMode()" id="markerModeOffBtn">Off</button>
                </td>
            </tr>
            <tr>
                <td>Clipboard</td>
                <td>
                    <button class="skeuButton" onclick="copyMarkedCells()">Copy</button>
                    <button class="skeuButton" onclick="pasteMarkedCells()">Paste after current step</button>
                </td>
            </tr>
        </table>
    </div>

    <div class="card">
        <table id="shortcutsTable">
            <tr>
                <td>←</td>
                <td>Step left</td>
            </tr>
            <tr>
                <td>→</td>
                <td>Step right</td>
            </tr>
            <tr>
                <td>Space</td>
                <td>Start/Stop playback</td>
            </tr>
            <tr>
                <td>Tab ↹</td>
                <td>Cycle note duration</td>
            </tr>
            <tr>
                <td>m</td>
                <td>Toggle section marking</td>
            </tr>
            <tr>
                <td>n</td>
                <td>Add step to end</td>
            </tr>
            <tr>
                <td>c</td>
                <td>Copy</td>
            </tr>
            <tr>
                <td>v</td>
                <td>Paste</td>
            </tr>
            <tr>
                <td>w</td>
                <td>Toggle wide mode</td>
            </tr>
            <tr>
                <td>i</td>
                <td>Insert column at current position</td>
            </tr>
            <tr>
                <td>&lt;</td>
                <td>Jump to start</td>
            </tr>
            <tr>
                <td>←Bksp</td>
                <td>Delete current column</td>
            </tr>
            <tr>
                <td>d</td>
                <td>Toggle dark mode</td>
            </tr>
        </table>
    </div>

    <div id="snapshots" class="card card_hidden">
        <span class='card_hide_toggle' onclick='hideCard(this)'></span>
        <p>Snapshot history</p>
    </div>

    <canvas id="faviconCanvas" style="display: none;"></canvas>

</body>
<script>
    'use strict'

    function init() {
        stepChange(stepCount);
        trackSelectorGenerator();
        read_url_params_and_apply();
        setFavicon(defaultFavicon, defaultFaviconAlpha)

        if (doWarn) {
            window.onbeforeunload = function () { return "Your work will be lost."; };
        }

        window.addEventListener("keydown", keyHandler)

        initFancyTrackSelection()
    }

    function initFancyTrackSelection() {
        var fancyData = []
        var metadataFields = new Set()
        var categories = new Set()

        // add calculated metadata fields
        for (var t in tracks) {
            var data = tracks[t]

            // init metadata if needs be
            if (!Object.keys(data).includes("metadata")) {
                data["metadata"] = { "category": "uncategorised" }
            }

            // noteCount
            var noteCount = data["notes"].length
            if (Object.keys(data).includes("doublenotes")) {
                noteCount + data["doublenotes"].length
            }
            if (Object.keys(data).includes("halfnotes")) {
                noteCount + data["halfnotes"].length
            }

            data.metadata.noteCount = noteCount

            // bpm
            var bpm = Math.round(60 / data["duration"])
            data.metadata.bpm = bpm

            // actual duration
            var actualDuration = Math.round(data["duration"] * data["steps"]) // seconds
            actualDuration = actualDuration < 60 ? `${actualDuration}s` : secondsToMins(actualDuration)
            data.metadata.actualDuration = actualDuration
        }

        // get all the metadata fields
        for (var t in tracks) {
            var data = tracks[t]
            if (Object.keys(data).includes("metadata")) {
                Object.keys(data["metadata"]).forEach(x => metadataFields.add(x))
            }
        }

        metadataFields = ["faviconContainer", "trackTitle", ...Array.from(metadataFields)]
        // get all categories
        for (var t in tracks) {
            var data = tracks[t]
            if (Object.keys(data).includes("metadata")) {
                categories.add(data.metadata.category)
            }
        }

        // delete uncategorised and re-add it to the end of a sorted array
        categories.delete("uncategorised")
        categories = [...Array.from(categories).toSorted(), "uncategorised"]

        for (var t in tracks) {
            var data = tracks[t]
            var tempArray = []

            // favicon (only set default alpha if we need to)
            var patternUrl = Object.keys(data).includes("favicon") ? data["favicon"] : defaultFavicon
            var alphaUrl = Object.keys(data).includes("favicon") && Object.keys(data).includes("faviconAlpha") ? data["faviconAlpha"] : Object.keys(data).includes("favicon") ? undefined : defaultFaviconAlpha
            var faviconDataUrl = gridUrlToDataUrl(patternUrl, alphaUrl)
            var faviconElm = document.createElement("img")
            faviconElm.src = faviconDataUrl
            faviconElm.classList.add("trackIcon")
            tempArray.push(faviconElm.outerHTML)

            // track title
            tempArray.push(t)

            // metadata
            if (Object.keys(data).includes("metadata")) {
                for (var i = 2; i < metadataFields.length; i++) {
                    var tempMeta = data["metadata"][metadataFields[i]]
                    tempArray.push(tempMeta ? tempMeta : "")
                }
            }
            else {
                for (var i = 2; i < metadataFields.length; i++) {
                    tempArray.push(metadataFields[i] == "category" ? "uncategorised" : "")
                }
            }

            fancyData.push(tempArray)
        }

        // put all the fancy data into a table
        var trackCardContainerElm = document.createElement("div")
        trackCardContainerElm.id = "trackCardContainer"

        var trackCardsByCategory = {}
        categories.forEach(x => trackCardsByCategory[x] = []) // init

        for (var i = 0; i < fancyData.length; i++) {
            var trackCardElm = document.createElement("div")
            trackCardElm.classList.add("trackCard")
            trackCardElm.innerHTML = fancyData[i].map((x, i) => [x, `<div class="tc_${metadataFields[i]}">${x}</div>`]).filter(x => x[0].toString().length).map(x => x[1]).join("")
            trackCardsByCategory[fancyData[i][2]].push(trackCardElm)
        }

        for (var i = 0; i < categories.length; i++) {
            var sectionHeaderElm = document.createElement("div")
            sectionHeaderElm.classList.add("tc_categorySection")
            sectionHeaderElm.innerHTML = categories[i]
            trackCardContainerElm.appendChild(sectionHeaderElm)
            trackCardsByCategory[categories[i]].forEach(x => trackCardContainerElm.appendChild(x))
        }

        // put the fancy table in a card and append
        var newCard = document.createElement("div")
        newCard.classList.add("card")
        newCard.appendChild(trackCardContainerElm)
        document.body.appendChild(newCard)
    }

    function secondsToMins(inputSeconds) {
        var minutes = Math.floor(inputSeconds / 60)
        var seconds = inputSeconds % 60
        return `${minutes}m ${seconds}s`
    }

    // globals
    var numberOfOctaves = 2
    var startOctave = 3
    var stepCount = 16
    var currentStep = -1
    var stepDuration = 0.5
    var chromaticScale = ["A", "A♯", "B", "C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯"]
    var audioCtx
    var mainGainNode
    var volume = 0.15
    var autoStepIntervalIdArray = []
    var waveform = "sine"
    var tempState
    var isWideModeEnabled = 0
    var theGrid = document.getElementById("theGrid")
    var doWarn = true
    var attackTime
    var releaseTime
    var notePickerDuration = "single"
    var refreshIntervalId = undefined;
    var conwayInterval = 500
    var controlDiv = document.getElementById("controls")
    var markerArray = []
    var copiedNotesObj
    var snapshotArray = []
    var snapshotFrequencyMins = 1
    var snapshotArrayMax = 5
    var snapshotIntervalId = setInterval(takeSnapshot, snapshotFrequencyMins * 60 * 1000)
    var inhibitDarkModeToggle
    const canvas = document.getElementById('faviconCanvas')
    var ctx = canvas.getContext("2d");
    const defaultFavicon = "http://ashe.org.uk/grid.html?pattern=0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100000001001011111000000000001111100000000000111110000001001001110000000000000000000000000000000000000000000000000000&width=16&height=16&primary=000000&secondary=69abac"
    const defaultFaviconAlpha = "http://ashe.org.uk/grid.html?pattern=0000000000000000000000000000000000000000000111000000000011100000000001110000000001111111111111100111111111111110011000001111111001111111111111100111111111111110011111111111111001111111111111100111111111111110011111111111111001111111111111100000000000000000&width=16&height=16"

    // init
    init();
</script>

</html>